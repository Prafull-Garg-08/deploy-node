name: Deploy nodeJS to azure web app

on: [push, workflow_dispatch]

env:
    AZURE_WEBAPP_NAME: newwehapp112
    AZURE_WEBAPP_PACKAGE_PATH: '.'
    NODE_VERSION: '20.x'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: checkout
              uses: actions/checkout@v4

            - name: set up nodejs version
              uses: actions/setup-node@v4
              with:
                node-version: ${{env.NODE_VERSION}}

            - name: npm install, build, and test
              run: |
                   npm ci
                   npm run build --if-present
                   npm run test --if-present

            - name: upload artifact for deployement job
              uses: actions/upload-artifact@v4
              with:
                name: node-app
                path: release.zip
    deploy:
        runs-on: ubuntu-latest
        needs: build
        environment:
            name: 'production'
            url: ${{steps.deploy-to-webapp.outputs.webapp-url}}
        
        steps:
            - name: download artifact from build job
              uses: actions/download-artifact@v4
              with:
                name: node-app

            - name: deploy to azure web app
              id: deploy-to-webapp
              uses: azure/webapps-deploy@v4
              with:
                app-name: ${{env.AZURE_WEBAPP_NAME}}
                slot-name: 'production'
                publish-profile: ${{secrets.AZURE_WEBAPP_PUBLISH_PROFILE}}
                package: ${{env.AZURE_WEBAPP_PACKAGE_PATH}}
